<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title> Leitor de Produtos - Houpa! </title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="style.css">

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js" integrity="sha512-Tn2m0TIpgVyTzzvmxLNuqbSJH3JP8jm+Cy3hvHrW7ndTDcJ1w5mBiksqDBb8GpE2ksktFvDB/ykZ0mDpsZj20w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


</head>

<body>

    <main class="main">
        <div class="container">
            <div class="jumbotron">
                <div>
                    <!-- <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="mySwitch" name="darkmode" value="yes" checked>
                        <label class="form-check-label" for="mySwitch">Dark Mode</label>
                    </div> -->
                    <h2>
                        Consultar Pedido
                    </h2>
                </div>

                <div>
                    <form>
                        <div class="form-group">
                            <label for="orderNumber">Nº Pedido</label>
                            <input type="number" class="form-control" style="width:fit-content" id="order-id">
                            <small id="emailHelp" class="form-text text-muted">Nº Pedido: 134001954</small>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="search_order()">Buscar Pedido</button>
                    </form>
                </div>
        
        
                
                <!-- <div id="resultado"></div> -->
                <div class="line">
                    <div id="camera" style="width: 800px; height:500px;"></div>
                </div>

                <div>
                    <h2>Pedido</h2>
                    <div class="table-responsive">
                        <table id="order-itens-table" class="table">
                            <thead>
                                <th>Id</th>
                                <th>Desc</th>
                                <th>Qnt</th>
                                <th>Quantidade Lida</th>
                                <th><i class="fa-sharp fa-solid fa-trash"></i></th>
                            </thead>
                        </table>
                    </div>
                </div>


            </div>
        </div>

    </main>

    <script src="quagga.min.js"></script>

    <script>
        let ORDER = null;
    </script>

    <script>
        let DETECTION = true;

        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.querySelector('#camera')    // Or '#yourElement' (optional)
            },
            decoder: {
                readers: ["code_128_reader"]
            }
        }, function (err) {
            if (err) {
                console.log(err);
                return
            }
            console.log("Initialization finished. Ready to start");
            Quagga.start();
        });

        Quagga.onDetected(function (data) {
            console.log(data.codeResult.code);
            // document.querySelector('#resultado').innerText = data.codeResult.code;
            if(DETECTION){
                register_read(data);
            }
        });

        function register_read(data){
            console.log("register_read - Order", ORDER);
            let table = document.getElementById('order-itens-table');
            const barcode = parseInt(data.codeResult.code);
            console.log("barcode readed", barcode);
            const item_idx = ORDER.itens.findIndex(item => item.id === barcode);
            console.log("index found", item_idx);

            if(item_idx == -1){
                console.log('[DBG] invalid read');
                return;
            }

            const readed_itens_qnt = parseInt(table.rows.item(item_idx).cells[3].innerHTML);
            console.log('readed qnt', readed_itens_qnt);

            table.rows.item(item_idx).cells[3].innerHTML = readed_itens_qnt + 1;
            emit_read_sound();
            lock_read();

            if(table.rows.item(item_idx).cells[2].innerHTML == table.rows.item(item_idx).cells[3].innerHTML){
                alert('ok');
            }

            function emit_read_sound(){
                const audio = new Audio("Barcode-scanner-beep-sound.mp3");
                audio.play();
            }
        }

        /* This should prevent multiple read in a short interval */
        function lock_read(timeout=2000){
            console.log('{DBG] locking');
            DETECTION = false;
            setTimeout(() => {
                console.log('[DBG] UNlocking');
                DETECTION = true;
            }, timeout);
        }

    </script>

    <script>
        orders = [
            {
                'id' : 1234,
                'itens' : [
                    {'id' : 1, 'desc' : 'calça acetinada verde 38', 'qnt' : 1},
                    {'id' : 23617, 'desc' : 'calça acetinada azul 40', 'qnt' : 2},
                    {'id' : 3, 'desc' : 'calça acetinada branca 42', 'qnt' : 1},
                ],
            },
            {
                'id' : 1235,
                'itens' : [
                    {'id' : 4, 'desc' : 'blusa rosa M', 'qnt' : 1},
                    {'id' : 5, 'desc' : 'calça acetinada azul 40', 'qnt' : 2}
                ],
            },

        ]

        function search_order(){
            const order_id = parseInt(document.getElementById('order-id').value);
            let order = orders.find(order => order.id === order_id);
            console.log(orders, order, order_id);
            if(order === null){
                console.log("Order not found");
            }
            else{
                load_itens(order);
                ORDER = order;
            }
        }

        function load_itens(order){
            console.log("Order", order);
            let table = document.getElementById('order-itens-table');
            order.itens.forEach((item, idx) => {
                let row = table.insertRow(-1);
                var cell1 = row.insertCell(0);
                var cell2 = row.insertCell(1);
                var cell3 = row.insertCell(2);
                var cell4 = row.insertCell(3);
                var cell5 = row.insertCell(4);
                cell1.innerHTML = item.id;
                cell2.innerHTML = item.desc;
                cell3.innerHTML = item.qnt;
                cell4.innerHTML = 0;
                cell5.innerHTML = `<button type="button" class="btn btn-danger" onclick="delete_item(${idx})" disabled><i class="fa-sharp fa-solid fa-trash"></i></button>`;
            });
        }
    </script>

</body>

</html>